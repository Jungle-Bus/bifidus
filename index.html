<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <title>Bidifus, improve your transit</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet'/>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div id='map'></div>
        <script>
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'positron_glstyle.json',
                center: [
                    2.5048, 48.8631
                ],
                zoom: 14,
                hash: true
            });
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            }));

            map.on('load', function () {
                map.loadImage('https://upload.wikimedia.org/wikipedia/commons/a/a4/Ic%C3%B4ne-bact%C3%A9riologie.png?uselang=fr', function (error, image) {
                    if (error)
                        throw error;
                    map.addImage('bifidus', image);
                });
                map.addLayer({
                    "id": "issues",
                    "type": "symbol",
                    "source": {
                        "type": 'vector',
                        "tiles": ["https://cors.5apps.com/?uri=http://osmose.openstreetmap.fr/fr/map/issues/{z}/{x}/{y}.mvt?item=8040,1260,2140"],
                        "attribution": "Osmose"
                    },
                    "source-layer": "issues",
                    "minzoom": 12,
                    "filter": [
                        "==", "$type", "Point"
                    ],
                    "layout": {
                        "icon-image": "bifidus",
                        "icon-size": 0.15
                    }
                });
                map.on('mouseenter', 'issues', function (e) {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', 'issues', function () {
                    map.getCanvas().style.cursor = '';
                });

                map.on('click', 'issues', function (e) {
                    var popup = new mapboxgl.Popup().setLngLat(e.features[0].geometry.coordinates).setHTML(
                        "<br><a target='blank_' href='http://osmose.openstreetmap.fr/fr/api/0.2/error/" + e.features[0].properties.issue_id + "'>Voir cette erreur</a>"
                    )
                    popup.addTo(map);
                    var item_id = e.features[0]['properties']['item'];

                    fetch("https://cors.5apps.com/?uri=http://osmose.openstreetmap.fr/fr/api/0.2/error/" + e.features[0].properties.issue_id).then(function (res) {
                        if (res.ok) {
                            res.json().then(function (data) {
                                if (item_id == 8040) {
                                    var popup_content = "<b>Cet arrÃªt semble manquant</b> <br/>"
                                    popup_content += data['subtitle']
                                    var mapcontrib_url = 'https://www.cartes.xyz/t/e7200d-Arrets_de_bus#position/18/' + e.features[0].geometry.coordinates[1] + '/' + e.features[0].geometry.coordinates[0];
                                    popup_content += "<br><a target='blank_' href='" + mapcontrib_url + "'>Voir sur MapContrib</a>"
                                } else {
                                    var popup_content = "<b>" + data['title'] + "<br/>"
                                    for (elem_id in data['elems']) {
                                        elem = data['elems'][elem_id]
                                        var osm_url = 'http://osm.org/' + elem['type'] + '/' + elem['id'];
                                        popup_content += "<br><a target='blank_' href='" + osm_url + "'>Voir sur OSM</a>"
                                    }
                                }
                                popup.setHTML(popup_content)
                            });
                        } else {
                            console.log("Fetch failed!", res.status);
                        }
                    }, function (e) {
                        console.log("Fetch failed!", e);
                    });
                });
            })
        </script>
    </body>
</html>
pt>
</body>
</html>
